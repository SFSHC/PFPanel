name: Build and Release Executable

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ workflow

jobs:
  build:
    runs-on: ubuntu-22.04 # ä½¿ç”¨ Ubuntu 22.04 ç³»ç»Ÿ
    permissions: write-all # æ˜¾å¼å£°æ˜ Workflow å†™å…¥æƒé™

    steps:
      - name: Checkout code # æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: Set up Python 3.10 # è®¾ç½® Python 3.10 ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies # å®‰è£… Python ä¾èµ–
        run: pip install -r requirements.txt

      - name: Install PyInstaller # å®‰è£… PyInstaller
        run: pip install pyinstaller

      - name: Create executable with PyInstaller # ä½¿ç”¨ PyInstaller åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
        run: pyinstaller --onefile --name pfpanel --add-data "templates:templates" pfpanel.py # <-- ä¿®æ”¹äº† --add-data å‚æ•°

      - name: Create GitHub Release # åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GitHub Token
        with:
          tag_name: v1.5.0-${{ github.run_number }} # Release tagï¼Œä¾‹å¦‚ v1.5.0-123 (Run Number)
          release_name: Polyfield Server Panel v1.5.0 (Build ${{ github.run_number }}) # Release åç§°
          body: |
            ğŸ‰ è‡ªåŠ¨æ„å»ºçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç‰ˆæœ¬ v1.5.0ï¼ ğŸ‰

            æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
            - è‡ªåŠ¨æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶
            - åŒ…å« HTML æ¨¡æ¿æ–‡ä»¶
            - ä½¿ç”¨ GitHub Actions è‡ªåŠ¨å‘å¸ƒ

            æ„Ÿè°¢ä½¿ç”¨ Polyfield Server Panel!  å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æäº¤ Issueã€‚
          draft: false # æ˜¯å¦ä¸ºè‰ç¨¿ Releaseï¼Œè®¾ç½®ä¸º false å‘å¸ƒæ­£å¼ Release
          prerelease: false # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œè®¾ç½®ä¸º false å‘å¸ƒæ­£å¼ Release

      - name: Upload executable to Release # ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶åˆ° Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # ä» create_release æ­¥éª¤è·å–ä¸Šä¼  URL
          asset_path: ./dist/pfpanel # å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ (PyInstaller é»˜è®¤è¾“å‡ºç›®å½•ä¸º dist)
          asset_name: pfpanel-linux-x64 # Release èµ„æºåç§°ï¼Œä¾‹å¦‚ pfpanel-linux-x64
          asset_content_type: application/octet-stream # èµ„æº MIME ç±»å‹ï¼Œå¯æ‰§è¡Œæ–‡ä»¶é€šå¸¸ä½¿ç”¨ application/octet-stream
